# Meta Interview Pack Data Design

This document describes the edge cases and test rationale for the `pack_meta_interview` challenge pack.

---

## Sprint Summary (December 2025)

### Problem Statement
Tests were passing by accident due to weak assertions and missing edge cases. A query with incorrect logic (e.g., missing WHERE clause) could accidentally return the right row count.

### Improvements Made

| Metric | Before | After |
|--------|--------|-------|
| Total test assertions | ~60 | 125+ |
| Avg tests per challenge | 3 | 6-7 |
| Edge case coverage | Minimal | Comprehensive |
| Value validation tests | Few | All challenges |
| Data generation script | v2 | v3 (900+ lines) |

### Key Changes

1. **Data Generation (v3)**
   - Created `scripts/generate-meta-interview-data-v3.py` (~900 lines)
   - 18 parquet files with comprehensive edge cases
   - Decoy data added to catch missing filters
   - Boundary values for date ranges and counts

2. **Test Improvements**
   - Added SQL-based value validation (not just ROWCOUNT)
   - Edge case exclusion tests (e.g., `excludes_june_only_users`)
   - Order validation tests (`ordered_by_*_desc`)
   - Formula validation tests (`formula_correct`)
   - All 8 state transitions tested for Q12

3. **Challenges with Most Changes**
   - Q3: Added CTR=0 edge case, division by zero handling
   - Q5: Expanded from 3 to 17 recommendation pairs
   - Q9: All 5 histogram buckets validated
   - Q12: All 8 advertiser state transitions mapped
   - Q14: DENSE_RANK tie handling for Tech category

### Verification
```bash
python3 scripts/test-solutions-duckdb.py
# Result: ✓ Passed: 20, ✗ Failed: 0
```

---

## Overview

The data was designed to catch common SQL mistakes by including:
- **Decoy data**: Records that should be excluded by correct queries
- **Boundary values**: Data at exact boundaries (e.g., exactly 28 days for churn)
- **Edge cases**: Empty sets, zero values, ties, and special scenarios

## Data Generation

Generated by `scripts/generate-meta-interview-data-v3.py` which creates 18 parquet files with comprehensive edge cases.

---

## Challenge-Specific Edge Cases

### Q1: Average Post Hiatus

**Purpose**: Test date filtering and HAVING clause

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| 2023 posts | Users 1-6 have posts from 2023 | Missing `WHERE YEAR(post_date) = 2024` |
| 2025 posts | Users 5, 7, 8 have posts in 2025 | Incomplete year filter |
| Single-post users | Some users have only 1 post in 2024 | Missing `HAVING COUNT(*) >= 2` |
| Same-day posts | User with 2 posts same day (days_between=0) | Edge case for date math |

**Tests Added**:
- `excludes_2023_posts`: Verifies no results have first_post_date before 2024
- `excludes_single_post_users`: Verifies all users have 2+ posts

---

### Q2: MAU Retention

**Purpose**: Test set intersection logic for retention

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| June-only users | Users 26, 27 active in June but NOT July | Missing July activity check |
| July-only users | Users 28, 29 active in July but NOT June | Missing June activity check |
| Both-month users | Users 1-15 active in both months | Should be in result |

**Tests Added**:
- `excludes_june_only_users`: Users 26, 27 should not appear
- `excludes_july_only_users`: Users 28, 29 should not appear

---

### Q3: Click-Through Rate (CTR)

**Purpose**: Test CTR formula and division handling

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| App 5: Zero clicks | Has impressions but 0 clicks (CTR=0) | Tests CTR=0 is valid |
| App 6: No impressions | Has clicks but 0 impressions | Should be excluded (division by zero) |
| Non-CTR actions | Actions like 'post', 'like' in data | Should only count impression/click |

**Tests Added**:
- `excludes_app_with_no_impressions`: App 6 should not appear
- `includes_app_with_zero_ctr`: App 5 with CTR=0 should appear
- `ordered_by_ctr_desc`: Verifies descending order

---

### Q4: Pages With No Likes

**Purpose**: Test anti-join patterns (LEFT JOIN + IS NULL)

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Pages 8, 9, 10 | Pages with zero likes | Should be in result |
| Pages 1-7 | Pages with likes | Should be excluded |

**Tests Added**:
- `excludes_pages_with_likes`: No pages with likes in result
- `includes_expected_pages`: Pages 8, 9, 10 are present

---

### Q5: Friend Recommendations

**Purpose**: Test self-join and event filtering

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Private vs public events | Only private events count | Missing `is_private = true` |
| Existing friends | Pairs who share events but are already friends | Missing friendship exclusion |
| 1 shared event | Pairs with only 1 shared event | Missing `HAVING COUNT >= 2` |

**Tests Added**:
- `only_private_events`: No pairs from public events
- `excludes_existing_friends`: No existing friendships in result
- `min_2_shared_events`: All pairs have 2+ shared events

---

### Q6: Weekly Churn Rate

**Purpose**: Test churn definition and rate calculation

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Week 1: 30% churn | 3 of 10 users churned | Validates rate calculation |
| 28-day boundary | Users at exactly 28 days | Tests boundary condition |

**Tests Added**:
- `churned_never_exceeds_total`: Sanity check
- `formula_correct`: Validates churned/total * 100

---

### Q7: Video Call Percentage

**Purpose**: Test percentage calculation with specific date

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Specific date | Uses 2024-11-29 | Wrong date returns different results |
| Video vs audio | Only video calls count | Missing call_type filter |

**Tests Added**:
- `percentage_in_valid_range`: Between 0-100%
- `correct_active_users`: Validates denominator
- `correct_video_callers`: Validates numerator

---

### Q8: Users With 3+ Distinct Calls

**Purpose**: Test COUNT DISTINCT vs COUNT

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Repeated callees | Users calling same person multiple times | COUNT vs COUNT DISTINCT |
| 7-day window | Date range 2024-11-24 to 2024-11-30 | Wrong date range |

**Tests Added**:
- `uses_count_distinct`: Validates against expected distinct counts
- `ordered_by_callees_desc`: Verifies ordering

---

### Q9: Comment Histogram

**Purpose**: Test bucketing and LEFT JOIN for zeros

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Bucket '0' | Users with 0 comments (15 users) | Missing LEFT JOIN from users |
| Boundary values | 2, 5, 10 comments | Tests bucket boundaries |
| Bucket '10+' | Users with 11+ comments | Tests > vs >= |

**Tests Added**:
- `total_users_match`: Sum of all buckets = total users
- `all_buckets_present`: All 5 buckets exist
- `bucket_10plus_correct`: Validates 10+ bucket

---

### Q10: Rolling 7-Day Active Users

**Purpose**: Test rolling window with COUNT DISTINCT

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| November only | Only Nov 2024 dates in result | Date filter issues |
| 7-day window | Rolling distinct users | Can't use simple window SUM |

**Tests Added**:
- `all_november_dates`: No dates outside November
- `rolling_always_gte_daily`: Rolling count >= daily count

---

### Q11: Consecutive Login Streak

**Purpose**: Test gaps-and-islands pattern

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| 4-day streak | User with exactly 4 days | Missing `HAVING >= 5` |
| Broken streak | User with 5-day, gap, 3-day streaks | Should report longest (5) |
| Multiple logins per day | Same day multiple times | Should count as 1 day |

**Tests Added**:
- `all_streaks_at_least_5`: Minimum streak is 5
- `ordered_by_streak_desc`: Longest first

---

### Q12: Advertiser Status Transitions

**Purpose**: Test state machine logic

**Edge Cases**:
All 8 state transitions are represented:

| Old Status | Paid? | New Status | Example User |
|------------|-------|------------|--------------|
| NEW | Yes | EXISTING | 1 |
| NEW | No | CHURN | 3 |
| EXISTING | Yes | EXISTING | 5 |
| EXISTING | No | CHURN | 8 |
| CHURN | Yes | RESURRECT | 11 |
| CHURN | No | CHURN | 14 |
| RESURRECT | Yes | EXISTING | 17 |
| RESURRECT | No | CHURN | 19 |

**Tests Added**: One test for each transition verifying the correct new_status

---

### Q13: Page Recommendations

**Purpose**: Test friend-based recommendations with ranking

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Already liked | Pages user already liked | Missing NOT EXISTS |
| Top 3 limit | Only top 3 per user | Missing ROW_NUMBER filter |
| Bidirectional friends | Friendships stored one-way | Missing UNION for both directions |

**Tests Added**:
- `max_3_per_user`: No user has more than 3 recommendations
- `no_already_liked_pages`: Excludes pages user already liked

---

### Q14: Second Highest Engagement

**Purpose**: Test DENSE_RANK for handling ties

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Tied scores | Tech category has tie for 2nd | DENSE_RANK vs ROW_NUMBER |
| Single-post category | 'single' category with 1 post | Should be excluded |

**Tests Added**:
- `excludes_single_post_categories`: 'single' not in result
- `tech_has_tie`: Tech category returns 2 rows (tie)

---

### Q15: Cumulative Revenue

**Purpose**: Test running total with window functions

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| YTD never decreases | Cumulative sum monotonic | Wrong window frame |
| First month | YTD = monthly for month 1 | Window frame start |

**Tests Added**:
- `ytd_monotonic_increase`: YTD never decreases
- `ytd_equals_running_sum`: Validates cumulative formula

---

### Q16: Mutual Friends Count

**Purpose**: Test graph traversal for mutual friends

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| 2 mutual friends | Pairs with exactly 2 | Missing `HAVING >= 3` |
| Existing friends | Pairs who are already friends | Missing NOT EXISTS |
| Bidirectional | Friend relationships | Missing UNION |

**Tests Added**:
- `all_have_3plus_mutual`: Minimum 3 mutual friends
- `no_existing_friendships`: Excludes current friends

---

### Q17: DAU/MAU Stickiness

**Purpose**: Test two-level aggregation

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Stickiness 0-100% | Must be valid percentage | Invalid formula |
| Month 12 | 100% stickiness (same users daily) | Edge case verification |

**Tests Added**:
- `stickiness_in_valid_range`: Between 0-100%
- `mau_positive`: No zero MAU

---

### Q18: Deduplicate Records

**Purpose**: Test ROW_NUMBER for deduplication

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| Multiple duplicates | Users with 3+ records | Only keep most recent |
| Same timestamp | Tiebreaker scenario | Needs deterministic ordering |

**Tests Added**:
- `no_duplicate_users`: Each user appears once
- `most_recent_kept`: No newer records exist

---

### Q19: First Activity and Total Activities

**Purpose**: Test MIN() and COUNT() aggregation

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| 2023 activities | Some users have 2023 data | MIN should still work |

**Tests Added**:
- `first_date_is_earliest`: No earlier date exists
- `all_users_have_activities`: Total >= 1

---

### Q20: YoY MAU Growth

**Purpose**: Test year-over-year comparison with self-join

**Edge Cases**:
| Edge Case | Description | How It Catches Mistakes |
|-----------|-------------|------------------------|
| 2022 data | Should be excluded | Wrong year filter |
| Negative growth | Some months have decline | Tests formula handles negatives |

**Tests Added**:
- `growth_formula_correct`: Validates (new-old)/old * 100
- `excludes_2022_data`: Only 2023-2024 comparison

---

## Test Verification

Run all tests with:
```bash
python3 scripts/test-solutions-duckdb.py
```

Expected result: 20 challenges passed, 0 failed.

## Common SQL Mistakes Caught

| Mistake | Challenges Affected |
|---------|---------------------|
| Missing WHERE clause | Q1, Q3, Q7, Q10, Q15, Q20 |
| Missing HAVING clause | Q1, Q5, Q8, Q11, Q16 |
| COUNT vs COUNT DISTINCT | Q8, Q16 |
| Missing date filter | Q1, Q2, Q3, Q7, Q10, Q15, Q20 |
| Missing NOT EXISTS | Q4, Q5, Q13, Q16 |
| Wrong ORDER BY | Q1, Q3, Q8, Q11, Q16 |
| Division by zero | Q3 |
| LEFT JOIN vs INNER JOIN | Q4, Q9 |
| DENSE_RANK vs ROW_NUMBER | Q14 |
